<!DOCTYPE html>
<html>

<head>
    <title>Python Dashboard</title>
    <style>
        th,
        td,
        p,
        input {
            font: 14px Verdana;
        }

        table,
        th,
        td {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }

        th {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="Block1_collection">
        <!-- Select collections from database to proceed further -->
        <h3> Select from collections: </h3>
        <form>
            <select name="selectform" id="res" method="GET" action="/">
                {% for coll in collections %}
                <option value="{{coll}}" SELECTED>{{coll}}</option>"
                {% endfor %}
            </select>
            <a id="demo" onclick="selectCollection()" class="button execute" name="submit" value="submit">Submit</a>
        </form>
    </div>

    <div id="Block2_macid">
        <!-- Select macId from collection to proceed further -->
        <h3> Select from MAC IDs: </h3>
        <form>
            <select name="selectform" id="mac" method="GET" action="/">

            </select>
            <a id="demo" onclick="selectMacID()" class="button execute" name="submit" value="submit">Submit</a>
        </form>
    </div>

    <div id="Block3_showTable">
        <!-- Showcase further data -->
        <p id="showData"></p>
    </div>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!--<div id="Block4_showChart">-->
    <div id="drawChart">
        <!-- Showcase further data 
        
            <p id="drawChart"></p>
        -->
    </div>

</body>

<script>
    var selectColl;
    var selectMac;

    function selectCollection() {
        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        selectColl = document.getElementById("res");

        var raw = JSON.stringify({
            "select_col": selectColl.value,
            "Block": 1
        });

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };

        fetch("/", requestOptions)
            .then(response => response.text())
            .then(result => {
                result = JSON.parse(result)
                console.log(typeof (result))
                console.log(selectColl.value)
                console.log(result)
                let html = ""
                result.macId.map(item => {
                    html += `<option value="${item}" SELECTED>${item}</option>"`
                })
                document.getElementById("mac").innerHTML = html
            })
            .catch(error => console.log('error', error));
    }

    function selectMacID() {

        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        selectMac = document.getElementById("mac");

        var raw = JSON.stringify({
            "select_col": selectColl.value,
            "select_mac": selectMac.value,
            "Block": 2
        });

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };

        fetch("/", requestOptions)
            .then(response => response.text())
            .then(result => {
                result = JSON.parse(result)
                console.log(selectColl.value)
                console.log(selectMac.value)
                console.log(result)
                console.log(result.otherSeries)
                CreateTableFromJSON(result)
                drawBackgroundColor(result.otherSeries)

            })
            .catch(error => console.log('error', error));
    }

    function CreateTableFromJSON(e) {
        var receivedData = e
        console.log(receivedData.data)
        var myData = receivedData.data

        // EXTRACT VALUE FOR HTML HEADER. 
        // ('Book ID', 'Book Name', 'Category' and 'Price')
        var col = [];
        for (var i = 0; i < myData.length; i++) {
            for (var key in myData[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }

        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1); // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th"); // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < myData.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = myData[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("showData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);

        console.log("Last table block")

    }

    google.charts.load('44', {
        callback: drawBackgroundColor,
        packages: ['corechart']
    });

    function drawBackgroundColor(e) {
        var c = e;
        console.log(typeof(c))
        console.log(c)

        var data = new google.visualization.DataTable();
        data.addColumn('number', 'Index');
        data.addColumn('number', 'Reading');

        data.addRows(c);

        var options = {
            hAxis: {
                title: 'MV2'
            },
            vAxis: {
                title: 'Value'
            },
            backgroundColor: '#f1f8e9'
        };

        var chart = new google.visualization.LineChart(document.getElementById('drawChart'));
        chart.draw(data, options);
    }
</script>

</html>